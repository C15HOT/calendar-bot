# Настройка Google OAuth для непрерывной работы бота

## Проблема
Google refresh токены могут истекать или становиться недействительными по следующим причинам:
1. Пользователь не использовал приложение более 6 месяцев
2. Пользователь превысил лимит refresh токенов (50 токенов на пользователя)
3. Пользователь отозвал доступ к приложению
4. Изменения в настройках OAuth приложения

## Решение

### 1. Настройка Google Cloud Console

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Выберите ваш проект
3. Перейдите в "APIs & Services" > "Credentials"
4. Найдите ваше OAuth 2.0 Client ID
5. Убедитесь, что в настройках указаны правильные redirect URIs

### 2. Настройка OAuth Consent Screen

1. Перейдите в "OAuth consent screen"
2. Убедитесь, что приложение опубликовано или добавлены тестовые пользователи
3. В разделе "Scopes" добавьте:
   - `https://www.googleapis.com/auth/calendar.readonly`
   - `https://www.googleapis.com/auth/calendar.events`

### 3. Рекомендации для пользователей

При авторизации пользователи должны:
1. ✅ Отметить "Keep me signed in" если предлагается
2. ✅ Предоставить все запрашиваемые разрешения
3. ✅ Не отзывать доступ к приложению в настройках Google

### 4. Автоматическое обновление токенов

Бот теперь автоматически:
- ✅ Проверяет срок действия токенов
- ✅ Обновляет токены при необходимости
- ✅ Уведомляет пользователей о проблемах с аутентификацией
- ✅ Удаляет поврежденные токены

### 5. Мониторинг

Бот выполняет мониторинг каждые 6 часов:
- Проверяет состояние всех токенов
- Уведомляет пользователей о проблемах
- Автоматически обновляет истекающие токены

### 6. Команды для пользователей

- `/auth` - Первоначальная авторизация
- `/token_status` - Проверка состояния токена
- `/events` - Просмотр событий (автоматически проверит токен)

### 7. Логирование

Все операции с токенами логируются:
- Успешное обновление токенов
- Ошибки аутентификации
- Удаление поврежденных токенов
- Уведомления пользователей

## Технические детали

### Параметры OAuth запроса
```python
auth_url, _ = flow.authorization_url(
    access_type='offline',        # Получаем refresh token
    include_granted_scopes='true', # Включаем все разрешения
    prompt='consent'              # Принудительно запрашиваем согласие
)
```

### Проверка токенов
```python
if creds.expired:
    if creds.refresh_token:
        creds.refresh(Request())  # Обновляем токен
    else:
        # Требуется повторная авторизация
```

### Обработка ошибок
- 401/403 ошибки → Удаление токена и запрос повторной авторизации
- Отсутствие refresh токена → Удаление токена и запрос повторной авторизации
- Поврежденные токены → Удаление и запрос повторной авторизации

## Рекомендации по развертыванию

1. **Регулярные проверки**: Мониторинг токенов каждые 6 часов
2. **Логирование**: Включите подробное логирование для отслеживания проблем
3. **Уведомления**: Пользователи получают уведомления о проблемах с токенами
4. **Автоматическое восстановление**: Бот автоматически обновляет токены при возможности

## Устранение неполадок

### Проблема: "No refresh token available"
**Решение**: Пользователь должен использовать `/auth` для повторной авторизации

### Проблема: "Token expired"
**Решение**: Бот автоматически обновит токен, если есть refresh token

### Проблема: "Authentication failed"
**Решение**: Пользователь должен использовать `/auth` для повторной авторизации

### Проверка состояния
Используйте команду `/token_status` для проверки состояния токена 